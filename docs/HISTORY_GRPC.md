# gRPC Server ν•™μµ λ° κ°λ° μ΄λ ¥

μ΄ λ¬Έμ„λ” `grpc-server` ν”„λ΅μ νΈλ¥Ό μ§„ν–‰ν•λ©° ν•™μµν• λ‚΄μ©κ³Ό κ°λ° λ³€κ²½ μ‚¬ν•­μ„ κΈ°λ΅ν•©λ‹λ‹¤.
κΈ°μ΅΄μ— μ§„ν–‰ν–λ **Echo ν”„λ μ„μ›ν¬ κΈ°λ°μ HTTP μ›Ή μ„λ²„** ν”„λ΅μ νΈμ™€ λ‹¬λ¦¬, λ³Έ ν”„λ΅μ νΈλ” **gRPC ν”„λ΅ν† μ½μ ν•µμ‹¬ μ›λ¦¬μ™€ λ™μ‘ λ°©μ‹**μ„ κΉμ΄ μκ² μ΄ν•΄ν•λ” κ²ƒμ„ μµμ°μ„  λ©ν‘λ΅ ν•©λ‹λ‹¤.

## 1. ν”„λ΅μ νΈ κ°μ” λ° λ©μ 

*   **λ©ν‘**: gRPC, Protocol Buffers(Protobuf)μ μ΄ν•΄ λ° Go μ–Έμ–΄μ—μ„μ gRPC μ„λ²„ κµ¬ν„ ν•™μµ.
*   **μ°¨λ³„μ **: ν”„λ μ„μ›ν¬μ νΈλ¦¬ν• κΈ°λ¥(Magic)μ— μμ΅΄ν•κΈ°λ³΄λ‹¤, **Pure Go**μ— κ°€κΉμ΄ λ°©μ‹μΌλ΅ μ§μ ‘ μμ΅΄μ„±μ„ μ£Όμ…ν•κ³  μ„λ²„λ¥Ό κµ¬μ„±ν•μ—¬ λ‚΄λ¶€ λ™μ‘ νλ¦„μ„ λ…ν™•ν νμ•…ν•©λ‹λ‹¤.

## 2. κΈ°μ΅΄ ν”„λ΅μ νΈ(Board/Ecommerce)μ™€μ μ•„ν‚¤ν…μ² λ° κµ¬ν„ λΉ„κµ

λ³Έ μ„Ήμ…μ—μ„λ” Echo ν”„λ μ„μ›ν¬ κΈ°λ°μ `board`, `ecommerce` λ¨λ“κ³Ό ν„μ¬ `grpc-server` λ¨λ“μ μ•„ν‚¤ν…μ² λ° μμ΅΄μ„± μ£Όμ…(DI) λ°©μ‹μ μ°¨μ΄λ¥Ό λ¶„μ„ν•©λ‹λ‹¤.

### 2.1 ν†µμ‹  ν”„λ΅ν† μ½ λ° μ§„μ…μ  (Entry Point)

| κµ¬λ¶„ | Echo ν”„λ΅μ νΈ (`board`) | gRPC ν”„λ΅μ νΈ (`grpc-server`) |
| :--- | :--- | :--- |
| **κΈ°λ° ν”„λ΅ν† μ½** | HTTP/1.1 (JSON Text) | HTTP/2 (Protobuf Binary) |
| **λΌμ°ν…** | `e.GET("/posts", handler.List)` (URL Path) | `.proto` μ„λΉ„μ¤ λ©”μ„λ“ νΈμ¶ (RPC) |
| **λ°μ΄ν„° λ°”μΈλ”©** | `c.Bind(&dto)` (Reflection) | `protoc` μƒμ„± μ½”λ“ (Static Typing) |

### 2.2 μμ΅΄μ„± μ£Όμ…(DI) λ° ν¬μΈν„° μ‚¬μ© μ „λµ λΉ„κµ

λ‘ ν”„λ΅μ νΈ λ¨λ‘ `Main` ν•¨μμ—μ„ μμ΅΄μ„±μ„ μ΅°λ¦½(Wiring)ν•μ§€λ§, **μ¶”μƒν™” μμ¤€κ³Ό ν¬μΈν„° λ…Έμ¶ μ—¬λ¶€**μ—μ„ ν° μ°¨μ΄λ¥Ό λ³΄μ…λ‹λ‹¤.

#### A. Board λ¨λ“: μΈν„°νμ΄μ¤ κΈ°λ° (Loose Coupling)
`board` λ¨λ“μ€ **μ² μ €ν• μΈν„°νμ΄μ¤ κΈ°λ° μ„¤κ³„**λ¥Ό λ”°λ¦…λ‹λ‹¤.

*   **μ½”λ“ ν•νƒ**:
    ```go
    // board/cmd/app/main.go
    // λ°ν™ νƒ€μ…μ΄ Interface (κµ¬μ²΄μ μΈ κµ¬μ΅°μ²΄ *memoryPostRepositoryκ°€ μ•„λ‹)
    postRepo := repository.NewMemoryPostRepository() 
    postSvc := service.NewPostService(postRepo)
    ```
*   **ν¬μΈν„° μ‚¬μ© (Implicit)**:
    *   μ½”λ“ μƒμ—μ„ `*` (Asterisk)κ°€ λ³΄μ΄μ§€ μ•μ§€λ§, λ‚΄λ¶€μ μΌλ΅ μΈν„°νμ΄μ¤ λ³€μλ” κµ¬ν„μ²΄μ **ν¬μΈν„°**λ¥Ό λ‹΄κ³  μμµλ‹λ‹¤.
    *   `NewPostService`μ λ¦¬ν„΄ νƒ€μ…μ€ `PostService` (Interface)μ…λ‹λ‹¤.
*   **μ¥μ **:
    *   **λμ¨ν• κ²°ν•©**: `main.go`λ” `memoryPostRepository`μΈμ§€ `mysqlPostRepository`μΈμ§€ μ• ν•„μ”κ°€ μ—†μµλ‹λ‹¤.
    *   **ν…μ¤νΈ μ©μ΄μ„±**: `postSvc`μ— κ°€μ§ κ°μ²΄(Mock)λ¥Ό μ£Όμ…ν•κΈ° λ§¤μ° μ‰½μµλ‹λ‹¤.

#### B. gRPC Server λ¨λ“: κµ¬μ΅°μ²΄ ν¬μΈν„° κΈ°λ° (Tight Coupling & Explicit)
ν„μ¬ `grpc-server` λ¨λ“μ€ **κµ¬μ²΄μ μΈ κµ¬μ΅°μ²΄ ν¬μΈν„°**λ¥Ό μ§μ ‘ μ£Όκ³ λ°›μµλ‹λ‹¤.

*   **μ½”λ“ ν•νƒ**:
    ```go
    // grpc-server/cmd/app.go
    // λ°ν™ νƒ€μ…μ΄ *Repository (κµ¬μ²΄μ μΈ κµ¬μ΅°μ²΄ ν¬μΈν„°)
    if a.repository, err = repository.NewRepository(cfg); err != nil { ... }
    // μΈμλ΅ *Repository ν¬μΈν„°λ¥Ό μ§μ ‘ μ”κµ¬
    if a.service, err = service.NewService(cfg, a.repository); err != nil { ... }
    ```
*   **ν¬μΈν„° μ‚¬μ© (Explicit)**:
    *   `NewService` ν•¨μ μ‹κ·Έλ‹μ²λ¥Ό λ³΄λ©΄ `*repository.Repository`λ¥Ό μΈμλ΅ λ°›κ³ , `*Service`λ¥Ό λ°ν™ν•©λ‹λ‹¤.
    *   ν¬μΈν„° μ‚¬μ©μ΄ λ…μ‹μ μΌλ΅ λ“λ¬λ‚ μμµλ‹λ‹¤.
*   **μλ„ λ° νΉμ§•**:
    *   μ΄κΈ° κ°λ° λ‹¨κ³„μ—μ„ **κµ¬μ΅°μ™€ λ°μ΄ν„° νλ¦„μ„ λ…ν™•ν** ν•κΈ° μ„ν•΄ μ§κ΄€μ μΈ λ°©μ‹μ„ νƒν–μµλ‹λ‹¤.
    *   ν•μ§€λ§ μ΄λ” **κ°•ν• κ²°ν•©**μ„ μ΄λν•λ―€λ΅, μ¶”ν›„ ν…μ¤νΈ μ½”λ“ μ‘μ„±μ΄λ‚ μ €μ¥μ† κµμ²΄ μ‹ μ μ—°μ„±μ΄ λ–¨μ–΄μ§ μ μμµλ‹λ‹¤. (λ¦¬ν©ν† λ§ λ€μƒ)

### 2.3 μ”μ•½

*   **Board**: "λ‚λ” `PostRepository`λΌλ” **ν–‰μ„(Interface)**κ°€ ν•„μ”ν•΄. λ„κ°€ μ¤λ“  μƒκ΄€μ—†μ–΄." (μ μ—°ν•¨)
*   **gRPC Server**: "λ‚λ” `*repository.Repository`λΌλ” **μ‹¤μ²΄(Struct Pointer)**κ°€ ν•„μ”ν•΄. μ •ν™•ν μ–μ—¬μ•Όλ§ ν•΄." (λ…ν™•ν•μ§€λ§ κ²½μ§λ¨)

μ΄λ¬ν• μ°¨μ΄λ¥Ό μ΄ν•΄ν•κ³ , ν–¥ν›„ `grpc-server`λ„ μΈν„°νμ΄μ¤ κΈ°λ°μΌλ΅ λ¦¬ν©ν† λ§ν•μ—¬ μ μ—°μ„±μ„ ν™•λ³΄ν•λ” κ³Όμ •μ„ ν•™μµν•  μμ •μ…λ‹λ‹¤.

## 3. κ°λ° μ§„ν–‰ λ΅κ·Έ

### 3.1 μ΄κΈ° μ¤μΊν΄λ”© (Layered Architecture)
*   **Flag κΈ°λ° μ„¤μ • κ΄€λ¦¬**:
    *   `flag` ν¨ν‚¤μ§€λ¥Ό μ‚¬μ©ν•΄ μ‹¤ν–‰ μ‹μ μ— `config.toml` κ²½λ΅λ¥Ό μ£Όμ…λ°›μ.
    *   μ»΄νμΌ μ—†μ΄ ν™κ²½(Local, Prod)μ„ κµμ²΄ν•  μ μλ” μ μ—°μ„± ν™•λ³΄.
*   **Fail Fast μ „λµ**:
    *   `cmd/app.go` μ΄κΈ°ν™” κ³Όμ •μ—μ„ μμ΅΄μ„± μ£Όμ… μ‹¤ν¨ μ‹ μ¦‰μ‹ `panic`μ„ λ°μƒμ‹μΌ, μλ»λ μƒνƒλ΅ μ„λ²„κ°€ μΌμ§€λ” κ²ƒμ„ λ°©μ§€.

### 3.2 Web Framework λ„μ… (Gin)
*   **Gin Framework μ„ νƒ**:
    *   ν”„λ΅μ νΈμ λ©”μΈ κ·μΉ™μ€ Echoλ¥Ό μ‚¬μ©ν•μ§€λ§, λ³Έ `grpc-server` λ¨λ“μ—μ„λ” ν•™μµ λ° gRPC Gateway μ—­ν•  μν–‰ λ“±μ„ μ„ν•΄ **Gin Framework**λ¥Ό λ„μ…ν–μµλ‹λ‹¤.
    *   `network/router.go`μ—μ„ `gin.Engine`μ„ μ΄κΈ°ν™”ν•κ³ , `StartServer()` λ©”μ„λ“λ¥Ό ν†µν•΄ HTTP μ„λ²„λ¥Ό κµ¬λ™ν•©λ‹λ‹¤.
*   **κµ¬ν„ λ‚΄μ©**:
    *   `gin.New()`λ¥Ό ν†µν• μ—”μ§„ μ΄κΈ°ν™”.
    *   `:8080` ν¬νΈλ΅ μ„λ²„ λ°”μΈλ”©.

### 3.3 gRPC ν™κ²½ κµ¬μ¶• λ° μ΄κΈ° μ„λΉ„μ¤ μ •μ
*   **ν”„λ΅ν† μ½ λ²„νΌ(Protocol Buffers) μ„¤μ •**:
    *   Windows λ° macOS/Linux ν™κ²½μ„ μ„ν• `protoc` μ„¤μΉ λ° Go ν”λ¬κ·ΈμΈ(`protoc-gen-go`, `protoc-gen-go-grpc`) μ„¤μ • κ°€μ΄λ“(`docs/gRPC_SETTING.md`) μ‘μ„±.
*   **AuthService μ •μ (`auth.proto`)**:
    *   μΈμ¦ κ΄€λ ¨ RPC λ©”μ„λ“ `CreateAuth`, `VerifyAuth` μ„¤κ³„.
    *   ν† ν° μƒμ„±μ„ μ„ν• λ°μ΄ν„° κµ¬μ΅° `AuthData` λ° μ‘λ‹µ λ©”μ‹μ§€ μ •μ.
*   **μ½”λ“ μƒμ„±**:
    *   `protoc` λ…λ Ήμ–΄λ¥Ό ν†µν•΄ `.proto` νμΌλ΅λ¶€ν„° Go μ†μ¤ μ½”λ“(`auth.pb.go`, `auth_grpc.pb.go`) μƒμ„± μ„±κ³µ.
*   **μμ΅΄μ„± μ¶”κ°€**:
    *   `grpc`, `protobuf`, `paseto` (ν† ν° κ΄€λ¦¬), `gin` λ“± ν•µμ‹¬ λΌμ΄λΈλ¬λ¦¬ μμ΅΄μ„± μ£Όμ….

### 3.4 gRPC ν΄λΌμ΄μ–ΈνΈ μ„¤κ³„ λ° μƒνƒ κ³µμ  κ°λ… ν•™μµ (State Management)
gRPC μ„λΉ„μ¤ νΈμ¶μ„ λ‹΄λ‹Ήν•λ” ν΄λΌμ΄μ–ΈνΈ(`client.go`)λ¥Ό κµ¬ν„ν•λ©°, **κµ¬μ΅°μ²΄ ν•„λ“μ™€ λ©”μ„λ“ μΈμμ μ—­ν•  λ¶„λ¦¬**μ— λ€ν•΄ κΉμ΄ μκ² ν•™μµν–μµλ‹λ‹¤.

> π’΅ **μƒμ„Έ κ°€μ΄λ“**: κµ¬μ΅°μ²΄, ν¬μΈν„°, λ°μ΄ν„° νλ¦„μ— λ€ν• μ‰¬μ΄ λΉ„μ (μ€ν–‰ μ§μ›, κ³µκµ¬ν•¨ λ“±)μ™€ μƒμ„Έν• μ„¤λ…μ€ **[Go gRPC κ°λ° ν•µμ‹¬ κ°λ…: κµ¬μ΅°μ²΄μ™€ μƒνƒ κ΄€λ¦¬](./GO_GRPC_CONCEPTS.md)** λ¬Έμ„μ— λ³„λ„λ΅ μ •λ¦¬ν•΄ λ‘μ—μµλ‹λ‹¤.

#### A. κµ¬μ΅°μ²΄μ™€ μ„¤μ • κ³µμ  (Context vs. State)
μ΄κΈ° μλ¬Έμ : *"Config ν¬μΈν„°λ¥Ό κ³µμ ν•λ©΄ λ¨λ“  μ”μ²­μ΄ λ‘κ°™μ€ κ°’μ„ λ°”λΌλ³΄κ² λμ–΄ λ°μ΄ν„°κ°€ μ„μ΄μ§€ μ•μ„κΉ?"*

*   **ν•΄κ²° λ° μ •λ¦½λ κ°λ…**:
    *   **λ„κµ¬(Tools/Resources)**: `Config`, `ClientConn`(μ—°κ²° κ°μ²΄), `PasetoMaker`(ν† ν° μƒμ„±κΈ°) λ“±μ€ **λ¶λ³€(Immutable)**ν•κ±°λ‚ **κ³µμ λμ–΄μ•Ό ν•λ” μμ›**μ…λ‹λ‹¤. μ΄λ” `GRPCClient` κµ¬μ΅°μ²΄μ ν•„λ“λ΅ κ΄€λ¦¬ν•λ©°, ν¬μΈν„°λ΅ κ³µμ ν•μ—¬ λ©”λ¨λ¦¬ ν¨μ¨κ³Ό μΌκ΄€μ„±μ„ μ μ§€ν•©λ‹λ‹¤.
    *   **μ¬λ£(Data/Request)**: μ‚¬μ©μλ³„ μ”μ²­ λ°μ΄ν„°(`Address`, `Token` λ“±)λ” **κ°€λ³€(Mutable)**ν•λ©° μ”μ²­λ§λ‹¤ λ‹¤λ¦…λ‹λ‹¤. μ΄λ” κµ¬μ΅°μ²΄ ν•„λ“κ°€ μ•„λ‹ **λ©”μ„λ“μ μΈμ(Parameter)**λ΅ μ „λ‹¬λμ–΄ μ¤νƒ λ©”λ¨λ¦¬μ—μ„ μ²λ¦¬λκ³  μ†λ©Έν•©λ‹λ‹¤.

#### B. κµ¬ν„ λ‚΄μ© (`GRPCClient`)
*   **κµ¬μ΅°μ²΄ μ •μ**:
    ```go
    type GRPCClient struct {
        client      *grpc.ClientConn        // μ—°κ²° κ°μ²΄ (κ³µμ )
        authClient  auth.AuthServiceClient  // gRPC μ¤ν… (κ³µμ )
        pasetoMaker *paseto.PasetoMaker     // ν† ν° μƒμ„±κΈ° (κ³µμ )
    }
    ```
*   **μƒμ„±μ (`NewGRPCClient`)**:
    *   `grpc.Dial`μ„ ν†µν•΄ μ„λ²„μ™€ μ—°κ²°μ„ λ§Ίκ³  `insecure` μµμ…μΌλ΅ κ°λ° ν™κ²½ ν†µμ‹ μ„ μ„¤μ •.
    *   `Config` κµ¬μ΅°μ²΄λ¥Ό ν™•μ¥ν•μ—¬ gRPC μ„λ²„ URL(`GRPC.URL`)μ„ μ™Έλ¶€ μ„¤μ • νμΌμ—μ„ μ£Όμ…λ°›λ„λ΅ κ°μ„ .
*   **Paseto λ¨λ“ κ°μ„ **:
    *   `NewPasetoMaker` μƒμ„±μμ μΈμλ¥Ό κ°’(`config.Config`)μ—μ„ ν¬μΈν„°(`*config.Config`)λ΅ λ³€κ²½ν•μ—¬ μΌκ΄€μ„± ν™•λ³΄.

### 3.5 Paseto ν† ν° κ΄€λ¦¬ λ΅μ§ κµ¬ν„
Paseto(Platform-Agnostic SEcurity TOkens) λΌμ΄λΈλ¬λ¦¬λ¥Ό ν™μ©ν•μ—¬ μΈμ¦ ν† ν°μ„ μƒμ„±ν•κ³  κ²€μ¦ν•λ” λ΅μ§μ„ κµ¬μ²΄ν™”ν–μµλ‹λ‹¤.

*   **ν† ν° μƒμ„± (`CreateNewToken`)**:
    *   `crypto/rand` ν¨ν‚¤μ§€λ¥Ό μ‚¬μ©ν•μ—¬ 16λ°”μ΄νΈ λ‚μ(Random Salt/Nonce)λ¥Ό μƒμ„±.
    *   `Paseto.V2.Encrypt` λ©”μ„λ“λ¥Ό ν†µν•΄ ν† ν° λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•μ—¬ λ°ν™.
*   **ν† ν° κ²€μ¦ (`VerifyToken`)**:
    *   `Paseto.V2.Decrypt` λ©”μ„λ“λ¥Ό μ‚¬μ©ν•μ—¬ μ…λ ¥λ°›μ€ ν† ν°μ„ λ³µνΈν™”ν•κ³  μ„λ…μ„ κ²€μ¦.